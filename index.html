<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ready for the Age Sorting Process?</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 100%;
            overflow: hidden;
            border: 20px solid #1e3c72;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 40px 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
            line-height: 1.6;
        }

        .content {
            padding: 50px 40px;
            background: white;
        }

        .intro-text {
            text-align: center;
            color: #4a5568;
            font-size: 17px;
            line-height: 1.7;
            margin-bottom: 40px;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 30px;
        }

        button {
            padding: 18px 32px;
            font-size: 17px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        button:disabled:hover {
            box-shadow: none;
        }

        .view-photos {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        .begin-video {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        .processing {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .upload-photos {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .icon {
            font-size: 22px;
            position: relative;
            z-index: 1;
        }

        .button-text {
            position: relative;
            z-index: 1;
        }

        /* File Upload Section */
        .upload-section {
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .upload-section h3 {
            color: #2d3748;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .upload-section p {
            color: #718096;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .selected-files {
            margin-top: 20px;
            text-align: left;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }

        .file-item-name {
            color: #2d3748;
            font-size: 14px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-item-remove {
            color: #e53e3e;
            cursor: pointer;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .file-item-remove:hover {
            background: #fff5f5;
        }

        .upload-button {
            margin-top: 20px;
        }

        #statusMessage {
            text-align: center;
            padding: 16px;
            border-radius: 8px;
            font-size: 15px;
            margin-top: 20px;
        }

        #statusMessage.loading {
            background: #f0f4f8;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }

        #statusMessage.error {
            background: #fff5f5;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        #statusMessage.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        #statusMessage.hidden {
            display: none;
        }

        .info-box {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .info-box p {
            color: #4a5568;
            font-size: 15px;
            line-height: 1.6;
            margin: 0;
        }

        .info-box strong {
            color: #2d3748;
        }

        /* Success screen styles */
        .success-container {
            text-align: center;
            padding: 60px 40px;
        }

        .success-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: scaleIn 0.5s ease-out;
        }

        @keyframes scaleIn {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        .success-container h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 16px;
        }

        .success-container p {
            color: #4a5568;
            font-size: 17px;
            line-height: 1.7;
            margin-bottom: 12px;
        }

        .success-container .email-highlight {
            background: #f0f4f8;
            padding: 12px 20px;
            border-radius: 8px;
            display: inline-block;
            margin-top: 20px;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 26px;
            }

            .header p {
                font-size: 15px;
            }

            .content {
                padding: 40px 25px;
            }

            .intro-text {
                font-size: 16px;
            }

            button {
                padding: 16px 24px;
                font-size: 16px;
            }

            .upload-section {
                padding: 20px;
            }

            .success-container {
                padding: 50px 25px;
            }

            .success-container h1 {
                font-size: 26px;
            }

            .success-icon {
                font-size: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div class="header">
            <h1>Ready to Begin the Age Sorting Process?</h1>
            <p>We're here to help you honor your loved one's memory</p>
        </div>
        
        <div class="content">
            <p class="intro-text">
                Before we begin sorting your photos, you have the option to review all the photos that have been uploaded from you and any invitees. Once you're ready, we'll start sorting your photos.
            </p>
            
            <div class="button-container">
                <button class="view-photos" id="viewBtn" onclick="viewPhotos()" disabled>
                    <span class="icon">üìÅ</span>
                    <span class="button-text">View Uploaded Photos (might take a few seconds for them all to load)</span>
                </button>
            </div>

            <!-- File Upload Section (only shows when inviteothers=Yes) -->
            <div class="upload-section" id="uploadSection" style="display: none;">
                <h3>üì∏ Add Extra Photos (Optional)</h3>
                <p>You can add up to 10 additional photos before processing</p>
                
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" multiple accept="image/*,.zip" onchange="handleFileSelect(event)">
                    <label for="fileInput" class="file-input-label">
                        Choose Files or Drop Here
                    </label>
                </div>

                <div class="selected-files" id="selectedFiles"></div>

                <button class="upload-photos upload-button" id="uploadBtn" onclick="uploadFiles()" style="display: none;">
                    <span class="icon">‚òÅÔ∏è</span>
                    <span class="button-text">Upload Photos</span>
                </button>
            </div>

            <div class="button-container">
                <button class="begin-video" id="beginBtn" onclick="beginVideo()">
                    <span class="icon">üî¢</span>
                    <span class="button-text">Start Age Sorting Photos</span>
                </button>
            </div>

            <div class="info-box">
                <p>
                    <strong>What happens next?</strong><br>
                    Once you click "Start Age Sorting Photos", our algorithm will begin sorting your photos by age. 
                    You'll receive an email notification when it's ready, typically within 30 minutes.
                </p>
            </div>
            
            <div id="statusMessage" class="loading">
                <div class="spinner"></div>
                Loading photo link...
            </div>
        </div>
    </div>

    <script>
        // Get ALL parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid');
        const name = urlParams.get('name');
        const type = urlParams.get('type');
        const email = urlParams.get('email');
        const deceasedname = urlParams.get('deceasedname');
        const inviteothers = urlParams.get('inviteothers');
        const titlePhoto = urlParams.get('titlePhoto');
        const endPhoto = urlParams.get('endPhoto');
        
        let dropboxLink = '';
        let selectedFiles = [];
        const MAX_FILES = 10;
        const UPLOAD_LAMBDA_URL = 'https://qs6cadsch22yhnxrdp44k7xfou0ftimt.lambda-url.us-east-2.on.aws/'; // TODO: Replace with actual Lambda URL

        // Check if auto-processing should happen
        const shouldAutoProcess = inviteothers === 'No';

        if (shouldAutoProcess) {
            // Hide all buttons and info box
            const allButtonContainers = document.querySelectorAll('.button-container');
            allButtonContainers.forEach(container => container.style.display = 'none');
            document.getElementById('uploadSection').style.display = 'none';
            document.querySelector('.info-box').style.display = 'none';
            
            // Update intro text
            document.querySelector('.intro-text').textContent = 'Processing your memorial video... This will take just a moment.';
            
            // Show status message as loading
            const statusMsg = document.getElementById('statusMessage');
            statusMsg.className = 'loading';
            statusMsg.innerHTML = '<div class="spinner"></div> Preparing your photos (10 seconds)...';
            
            // Wait 10 seconds, then auto-call Lambda
            setTimeout(() => {
                statusMsg.innerHTML = '<div class="spinner"></div> Starting video processing...';
                beginVideoAuto();
            }, 10000);
            
        } else {
            // Show upload section for inviteothers=Yes
            document.getElementById('uploadSection').style.display = 'block';
            
            // Normal flow - fetch Dropbox link for "View Photos" button
            if (uid) {
                fetch(`https://order-by-age-uploads.s3.us-east-2.amazonaws.com/dropbox-links/${uid}.txt`)
                    .then(response => {
                        if (!response.ok) throw new Error('Link not found');
                        return response.text();
                    })
                    .then(link => {
                        dropboxLink = link.trim();
                        console.log('Fetched Dropbox link:', dropboxLink);
                        const statusMsg = document.getElementById('statusMessage');
                        statusMsg.classList.add('hidden');
                        document.getElementById('viewBtn').disabled = false;
                    })
                    .catch(error => {
                        console.error('Error fetching Dropbox link:', error);
                        const statusMsg = document.getElementById('statusMessage');
                        statusMsg.className = 'error';
                        statusMsg.innerHTML = '‚ö†Ô∏è Unable to load photo link. Please contact support.';
                    });
            } else {
                const statusMsg = document.getElementById('statusMessage');
                statusMsg.className = 'error';
                statusMsg.innerHTML = '‚ö†Ô∏è Order information missing. Please contact support.';
            }
        }

        // Drag and drop functionality
        const uploadSection = document.getElementById('uploadSection');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        });

        // Debug log
        console.log('All Parameters:', {
            uid,
            name,
            type,
            email,
            deceasedname,
            inviteothers,
            titlePhoto,
            endPhoto
        });

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            // Filter to only images and zip files
            const validFiles = files.filter(file => 
                file.type.startsWith('image/') || file.name.toLowerCase().endsWith('.zip')
            );

            // Check total count
            if (selectedFiles.length + validFiles.length > MAX_FILES) {
                alert(`You can only upload up to ${MAX_FILES} files total.`);
                return;
            }

            selectedFiles = selectedFiles.concat(validFiles);
            updateFileList();
            
            // Show upload button if files selected
            document.getElementById('uploadBtn').style.display = selectedFiles.length > 0 ? 'flex' : 'none';
        }

        function updateFileList() {
            const container = document.getElementById('selectedFiles');
            
            if (selectedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = selectedFiles.map((file, index) => `
                <div class="file-item">
                    <span class="file-item-name">${file.name}</span>
                    <span class="file-item-remove" onclick="removeFile(${index})">‚úï</span>
                </div>
            `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            document.getElementById('uploadBtn').style.display = selectedFiles.length > 0 ? 'flex' : 'none';
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) {
                alert('Please select files to upload');
                return;
            }

            const btn = document.getElementById('uploadBtn');
            const icon = btn.querySelector('.icon');
            const text = btn.querySelector('.button-text');
            const originalIcon = icon.innerHTML;
            const originalText = text.textContent;
            
            icon.innerHTML = '<div class="spinner"></div>';
            text.textContent = 'Uploading...';
            btn.disabled = true;

            const statusMsg = document.getElementById('statusMessage');
            statusMsg.className = 'loading';
            statusMsg.innerHTML = '<div class="spinner"></div> Uploading photos...';

            try {
                // Convert files to base64
                const filesData = await Promise.all(selectedFiles.map(async (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const base64 = reader.result.split(',')[1];
                            resolve({
                                filename: file.name,
                                data: base64
                            });
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                }));

                const uploadCount = selectedFiles.length;

                // Call Lambda (ignore CORS response errors since upload works)
                fetch(UPLOAD_LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        uid: uid,
                        name: name,
                        files: filesData
                    })
                }).catch(() => {
                    // Ignore fetch errors - we'll show success anyway after a delay
                });

                // Wait 2 seconds to ensure upload completes, then show success
                setTimeout(() => {
                    statusMsg.className = 'success';
                    statusMsg.innerHTML = `‚úì Successfully uploaded ${uploadCount} photo(s)!`;
                    
                    // Clear selected files
                    selectedFiles = [];
                    updateFileList();
                    document.getElementById('uploadBtn').style.display = 'none';
                    document.getElementById('fileInput').value = '';
                    
                    // Re-enable button
                    icon.innerHTML = originalIcon;
                    text.textContent = originalText;
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Upload error:', error);
                statusMsg.className = 'error';
                statusMsg.innerHTML = '‚ö†Ô∏è Upload failed. Please try again or contact support.';
                
                // Reset button
                icon.innerHTML = originalIcon;
                text.textContent = originalText;
                btn.disabled = false;
            }
        }
        function viewPhotos() {
            if (dropboxLink) {
                window.open(dropboxLink, '_blank');
            } else {
                alert('Dropbox link not available yet. Please wait a moment or contact support.');
            }
        }

        // Auto-processing version (no button UI changes needed)
        function beginVideoAuto() {
            if (!uid) {
                const statusMsg = document.getElementById('statusMessage');
                statusMsg.className = 'error';
                statusMsg.innerHTML = '‚ö†Ô∏è Order information missing. Please contact support.';
                return;
            }

            const statusMsg = document.getElementById('statusMessage');
            statusMsg.className = 'loading';
            statusMsg.innerHTML = '<div class="spinner"></div> Creating your memorial video...';

            // Normalize type to lowercase
            let normalizedType = "photos_only";
            if (type) {
                normalizedType = type.toLowerCase();
                if (normalizedType === "memorial_video") {
                    normalizedType = "memorial_video";
                }
            }

            // Build Dropbox folder path
            const folderPath = uid ? `/Order by age/${uid}` : null;

            // Build payload for Lambda
            const payload = {
                UID: uid,
                EMAIL: email,
                TYPE: normalizedType,
                NAME: name,
                DROPBOX_FOLDER_PATH: folderPath,
                TITLE_PHOTO_URL: titlePhoto || null,
                END_PHOTO_URL: endPhoto || null
            };

            console.log('Auto-calling Lambda:', payload);

            // Call Lambda directly
            fetch('https://kjr77tz4hysmixxtzzdp3ugtte0gceyq.lambda-url.us-east-2.on.aws/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('Lambda response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Lambda started successfully:', data);
                
                // Redirect to slide choosing form
                const redirectUrl = new URL('https://slidechoosing.memorialvideo.ai/');
                redirectUrl.searchParams.set('uid', uid);
                redirectUrl.searchParams.set('name', name || '');
                redirectUrl.searchParams.set('type', type || '');
                redirectUrl.searchParams.set('email', email || '');
                
                console.log('Redirecting to:', redirectUrl.toString());
                window.location.href = redirectUrl.toString();
            })
            .catch(error => {
                console.error('Lambda call failed:', error);
                statusMsg.className = 'error';
                statusMsg.innerHTML = '‚ö†Ô∏è Error starting video processing. Please contact support.';
            });
        }

        // Manual button click version (existing functionality)
        function beginVideo() {
            const btn = document.getElementById('beginBtn');
            const icon = btn.querySelector('.icon');
            const text = btn.querySelector('.button-text');
            
            icon.innerHTML = '<div class="spinner"></div>';
            text.textContent = 'Starting Processing...';
            btn.disabled = true;
            btn.className = 'processing';

            // Validate required fields
            if (!uid) {
                alert('Order information missing. Please contact support.');
                return;
            }

            // Normalize type to lowercase
            let normalizedType = "photos_only";
            if (type) {
                normalizedType = type.toLowerCase();
                if (normalizedType === "memorial_video") {
                    normalizedType = "memorial_video";
                }
            }

            // Build Dropbox folder path
            const folderPath = uid ? `/Order by age/${uid}` : null;

            // Build payload for Lambda
            const payload = {
                UID: uid,
                EMAIL: email,
                TYPE: normalizedType,
                NAME: name,
                DROPBOX_FOLDER_PATH: folderPath,
                TITLE_PHOTO_URL: titlePhoto || null,
                END_PHOTO_URL: endPhoto || null
            };

            console.log('Calling Lambda:', payload);

            // Call Lambda directly
            fetch('https://kjr77tz4hysmixxtzzdp3ugtte0gceyq.lambda-url.us-east-2.on.aws/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('Lambda response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Lambda started successfully:', data);
                
                // Redirect to slide choosing form
                const redirectUrl = new URL('https://slidechoosing.memorialvideo.ai/');
                redirectUrl.searchParams.set('uid', uid);
                redirectUrl.searchParams.set('name', name || '');
                redirectUrl.searchParams.set('type', type || '');
                redirectUrl.searchParams.set('email', email || '');
                
                console.log('Redirecting to:', redirectUrl.toString());
                window.location.href = redirectUrl.toString();
            })
            .catch(error => {
                console.error('Lambda call failed:', error);
                alert('There was an error starting the video processing. Please contact support.');
                icon.textContent = 'üé¨';
                text.textContent = 'Begin Video Processing';
                btn.disabled = false;
                btn.className = 'begin-video';
            });
        }
    </script>
</body>
</html>
